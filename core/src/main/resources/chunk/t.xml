<?xml version="1.0" encoding="UTF-8"?>

<!-- 
Terminator
XPath - 
-->
<chunk xmlns="https://www.phon.ca/ns/chunk">
    
    <!-- Parser -->
    <buffer name="Chat.g">
        <![CDATA[
t
	:	T_START T_ATTR_TYPE? mor? T_END 
	->	^(T_START T_ATTR_TYPE? mor?)
	;
]]>
    </buffer>
    
    <!-- Tree Walker -->
    <buffer name="ChatTree.g">
        <![CDATA[
t returns [String val]
scope {
 	IWord w; 	
}
@init {
 	List<IWord> grps = $u::utt.getWords();
 	$t::w = grps.get(grps.size()-1);
 }
	:	^(T_START T_ATTR_TYPE? mor?)
	{
		// add terminator to last wordgroup
		String t = $T_ATTR_TYPE.text;
		List<IWord> words = $u::utt.getWords();
		IWordGroup lastGrp = (IWordGroup)words.get(words.size()-1);
		String append = "";
		
		if(t.equals("p")) {
		   append = ".";
		} else if(t.equals("q")) {
		    append = "?";
		} else if(t.equals("e")) {
		    append = "!";
		} else {
		    // wrap in paren
		    append = "(t:" + t + ")";
		}
		
		List<String> cws = lastGrp.getWords();
		cws.add(append);
		lastGrp.setWords(cws);
		
		if($mor.val != null) {
			// mor is handled as a seperate dependent tier
			String morVal = $mor.val;
			String tierName = $mor.tierName;
			
			// make sure dep tier exists in session
			IDepTierDesc tierDesc = null;
			for(IDepTierDesc current:session.getWordAlignedTiers())
			{
				if(current.getTierName().equals(tierName))
				{
					tierDesc = current;
					break;
				}
			}
			
			if(tierDesc == null) {
				// create the new tier
				tierDesc = session.newDependentTier();
				tierDesc.setTierName(tierName);
				tierDesc.setIsGrouped(true);
			}
			
			// add mor data as a dep tier of the current word(group)
			IWord word = null;
			// get the correct word group holder
			if($t.size() > 0 || $ugrp.size() > 0) {
			    word = ($t.size() > 0 ? $t::w : $ugrp::w);
			} else if($u.size() > 0) {
			    word = $u::utt.getWords().get($u::utt.getWords().size()-1);
			}
			
			IDependentTier depTier = 
			    word.getDependentTier(tierDesc.getTierName());
			if(depTier == null) {
				depTier = word.newDependentTier();
				depTier.setTierName(tierDesc.getTierName());
			}
			String tierValue = depTier.getTierValue();
			tierValue += 
			    (tierValue.length() == 0 ? "" : " ") + morVal;
			depTier.setTierValue(tierValue);
		}
	}
	;
]]>
    </buffer>
    
    <buffer name="Phon2XmlWalker.g">
        <![CDATA[
t
	:	^(T_START T_ATTR_TYPE? m=mor?)
	->    template( type={$T_ATTR_TYPE}, morval={$m.st} )
	<<\<t type="<type>"<if(morval)>\><morval>\</t\><else>/\><endif> >>
	;
]]>
    </buffer>
	
	<include>mor.xml</include>
    
</chunk>