<?xml version="1.0" encoding="UTF-8"?>

<!-- 
Terminator
XPath - 
-->
<chunk xmlns="https://www.phon.ca/ns/chunk">
    
    <!-- Parser -->
    <buffer name="Chat.g">
        <![CDATA[
t
	:	T_START T_ATTR_TYPE? mor? T_END 
	->	^(T_START T_ATTR_TYPE? mor?)
	;
]]>
    </buffer>
    
    <!-- Tree Walker -->
    <buffer name="ChatTree.g">
        <![CDATA[
t returns [String val]
scope {
 	Group g; 	
}
@init {
 	$t::g = 
 		($u::r.numberOfGroups() > 0 ? $u::r.getGroup($u::r.numberOfGroups()-1) : $u::r.addGroup());
 }
	:	^(T_START T_ATTR_TYPE? mor?)
	{
		// add terminator to last wordgroup
		String t = $T_ATTR_TYPE.text;
		String append = "";
		if(t.equals("p")) {
		   append = ".";
		} else if(t.equals("q")) {
		    append = "?";
		} else if(t.equals("e")) {
		    append = "!";
		} else {
		    // wrap in paren
		    append = "(t:" + t + ")";
		}
		$t::g.setOrthography(
			(new OrthographyBuilder()).append($t::g.getOrthography()).append(append).toOrthography());
		
		if($mor.val != null) {
			// mor is handled as a seperate dependent tier
			String morVal = $mor.val;
			String tierName = $mor.tierName;
			
			// make sure dep tier exists in session
			TierDescription tierDesc = null;
			for(TierDescription current:session.getUserTiers())
			{
				if(current.getName().equals(tierName))
				{
					tierDesc = current;
					break;
				}
			}
			
			if(tierDesc == null) {
				// create the new tier
				tierDesc = sessionFactory.createTierDescription(tierDesc.getName(),
					tierDesc.isGrouped(), String.class);
				session.addUserTier(tierDesc);
				
				TierViewItem tvi = sessionFactory.createTierViewItem(
					tierDesc.getName(), true, "default");
				List<TierViewItem> tierView = session.getTierView();
				tierView.add(tvi);
				session.setTierView(tierView);
			}
			
			// add mor data as a dep tier of the current word(group)
			Group group = null;
			// get the correct word group holder
			if($t.size() > 0 || $ugrp.size() > 0) {
			    group = ($t.size() > 0 ? $t::g : $ugrp::g);
			} else if($u.size() > 0) {
			    group = $u::r.getGroup($u::r.numberOfGroups()-1);
			}
			
			String tierValue = group.getTier(tierDesc.getName(), String.class);
			if(tierValue == null) tierValue = new String();
			tierValue += 
			    (tierValue.length() == 0 ? "" : " ") + morVal;
			group.setTier(tierDesc.getName(), String.class, tierValue);
		}
	}
	;
]]>
    </buffer>
    
    <buffer name="Phon2XmlWalker.g">
        <![CDATA[
t
	:	^(T_START T_ATTR_TYPE? m=mor?)
	->    template( type={$T_ATTR_TYPE}, morval={$m.st} )
	<<\<t type="<type>"<if(morval)>\><morval>\</t\><else>/\><endif> >>
	;
]]>
    </buffer>
	
	<include>mor.xml</include>
    
</chunk>