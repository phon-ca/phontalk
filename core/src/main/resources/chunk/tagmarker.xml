<?xml version="1.0" encoding="UTF-8"?>

<!-- 
    tagMarker
    XPath - /xs:schema/xs:complexType[@name="tagMarkerType"]
-->
<chunk xmlns="http://phon.ling.mun.ca/ns/chunk">
    
    <!-- Parser -->
    <buffer name="Chat.g">
        <![CDATA[
tagmarker
	:	TAGMARKER_START TAGMARKER_ATTR_TYPE mor* TAGMARKER_END
	->	^(TAGMARKER_START TAGMARKER_ATTR_TYPE mor*)
	;
]]>
    </buffer>
    
    <!-- Tree Walker -->
    <buffer name="ChatTree.g">
        <![CDATA[
tagmarker returns [String val]
@init {
	List<Tuple<String, String>> morvals = new ArrayList<Tuple<String, String>>();
}
	:	^(TAGMARKER_START TAGMARKER_ATTR_TYPE (mor {morvals.add(new Tuple($mor.tierName, $mor.val));})*)
	{
	    String tmType = $TAGMARKER_ATTR_TYPE.text;
	    if(tmType.equals("comma")) {
	        $val = ",";
	    } else if(tmType.equals("tag")) {
	        $val = "\u201E";
	    } else if(tmType.equals("vocative")) {
	        $val = "\u2021";
	    }
	    
	    // add mor to mor tier as necessary
	    for(Tuple<String, String> morData:morvals) {
	    	// mor is handled as a seperate dependent tier
			String morVal = morData.getObj2();
			String tierName = morData.getObj1();
			
			// make sure dep tier exists in session
			IDepTierDesc tierDesc = null;
			for(IDepTierDesc current:session.getWordAlignedTiers())
			{
				if(current.getTierName().equals(tierName))
				{
					tierDesc = current;
					break;
				}
			}
			
			if(tierDesc == null) {
				// create the new tier
				tierDesc = session.newDependentTier();
				tierDesc.setTierName(tierName);
				tierDesc.setIsGrouped(true);
			}
			
			// add mor data as a dep tier of the current word(group)
			IWord word = null;
			// get the correct word group holder
			if($t.size() > 0 || $ugrp.size() > 0) {
			    word = ($t.size() > 0 ? $t::w : $ugrp::w);
			} else if($u::utt.getWords().size() > 0) {
			    word = $u::utt.getWords().get($u::utt.getWords().size()-1);
			}
			
			IDependentTier depTier = 
			    word.getDependentTier(tierDesc.getTierName());
			if(depTier == null) {
				depTier = word.newDependentTier();
				depTier.setTierName(tierDesc.getTierName());
			}
			String tierValue = depTier.getTierValue();
			tierValue += 
			    (tierValue.length() == 0 ? "" : " ") + morVal;
			depTier.setTierValue(tierValue);
	    }
	}
	;
]]>
    </buffer>
    
    <buffer name="Phon2XmlWalker.g">
        <![CDATA[
tagmarker
	:	^(TAGMARKER_START TAGMARKER_ATTR_TYPE (morlist+=mor)*)
	->    template(  type={$TAGMARKER_ATTR_TYPE.text},
	                 morcontent={$morlist}
	              )
	"\<tagMarker type=\"<type>\"\><if(morcontent)><morcontent><endif>\</tagMarker\>"
	;
]]>
    </buffer>
    
    <!-- Includes -->
    <include>mor.xml</include>
    
</chunk>