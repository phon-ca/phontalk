<?xml version="1.0" encoding="UTF-8"?>

<!-- 
Chat Element
Schema - http://www.talkbank.org/software/talkbank.xsd
XPath - /xs:schema/xs:element[@name="CHAT"]
-->

<chunk xmlns="https://www.phon.ca/ns/chunk">
    
    <!-- Parser -->
    <buffer name="Chat.g">
        <![CDATA[
chat
	:	CHAT_START chat_attrs* metadata? participants chat_content* CHAT_END 
	->	^(CHAT_START chat_attrs* participants? chat_content*)
	;
	
chat_content
	:	comment
	|	tcu
	|	begin_gem
	|	end_gem
	|	lazy_gem
	|	u
	;
	
chat_attrs
	|	CHAT_ATTR_VERSION
	|	CHAT_ATTR_DATE
	|	CHAT_ATTR_CORPUS
	:	CHAT_ATTR_MEDIA
	|	CHAT_ATTR_MEDIATYPES
	|	CHAT_ATTR_LANG
	|	CHAT_ATTR_OPTIONS
	|	CHAT_ATTR_COLORWORDS
	|	CHAT_ATTR_PID
	|	CHAT_ATTR_FONT
	;
]]>
    </buffer>
    
    <buffer name="ChatTree.g">
        <![CDATA[
chat
	:	^(CHAT_START chat_attrs* participants? chat_content*)
	;
	
chat_content
	:	comment
	{
		// add comment to last record
		if(session.getRecordCount() == 0)
			session.getMetadata().addComment($comment.comment);
		else
			session.getRecord(session.getRecordCount()-1).addComment($comment.comment);
	}
	|	u
	{
		session.addRecord($u.record);
	}
	|	lazy_gem
	{
		// add comment to last record
		if(session.getRecordCount() == 0)
			session.getMetadata().addComment($lazy_gem.lazyGem);
		else
			session.getRecord(session.getRecordCount()-1).addComment($lazy_gem.lazyGem);
	}
	;
	
chat_attrs
	:	CHAT_ATTR_VERSION
	|	CHAT_ATTR_DATE
	{
		LocalDate date = DateFormatter.stringToDateTime($CHAT_ATTR_DATE.text);
		session.setDate(date);
	}
	|	CHAT_ATTR_CORPUS
	{
		session.setCorpus($CHAT_ATTR_CORPUS.text);
	}
	|	CHAT_ATTR_MEDIA
	{	
		session.setMediaLocation($CHAT_ATTR_MEDIA.text + 
			(session.getMediaLocation() != null ? session.getMediaLocation() : ""));
	}
	|	CHAT_ATTR_MEDIATYPES
	{
		String suffix = ".wav";  // default media type
		String type = $CHAT_ATTR_MEDIATYPES.text;
		if(type.equals("aif") || type.equals("aiff"))
		{
			suffix = ".aiff";
		} else if(type.equals("mov") || type.equals("video"))
		{
			suffix = ".mov";
		}
		session.setMediaLocation(
			(session.getMediaLocation() != null ? session.getMediaLocation() : "") + suffix);
	}
	|	CHAT_ATTR_LANG
	{
		session.setLanguage($CHAT_ATTR_LANG.text);
	}
	|	CHAT_ATTR_OPTIONS
	{
		// TODO
	}
	|	CHAT_ATTR_COLORWORDS
	{
		// TODO
	}
	|	CHAT_ATTR_PID
	{
		Comment comment = sessionFactory.createComment();
		comment.setType(CommentEnum.Code);
		comment.setValue("pid " + $CHAT_ATTR_PID.text);
		session.getMetadata().addComment(comment);
	}
	|	CHAT_ATTR_FONT
	{
		// TODO
	}
	;
]]>
    </buffer>
	
	<buffer name="Phon2XmlWalker.g">
		<![CDATA[
chat
	:	^(CHAT_START (attrlist+=chat_attrs)* (partlist=participants)? (contentlist+=chat_content)*)
	->	template(
			attrs={$attrlist},
			parts={$partlist.st},
			content={$contentlist}
		)
	<<\<?xml version="1.0" encoding="UTF-8"?\>
\<CHAT 
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
	xmlns="http://www.talkbank.org/ns/talkbank"  
	xsi:schemaLocation="http://www.talkbank.org/ns/talkbank http://talkbank.org/software/talkbank.xsd" 
	<attrs; separator=""> \>
	<parts>
	<content; separator="">
\</CHAT\> >>
	;

chat_content
	:	comment
	->	template( v={$comment.st} )
		"<v>"
	|	u
	->	template( v={$u.st} )
		"<v>"
	|	lazy_gem
	->	template( v={$lazy_gem.st} )
		"<v>"
	;
	
chat_attrs
	:	CHAT_ATTR_VERSION
	->	template(version={$CHAT_ATTR_VERSION.text})
	<<
Version="<version>" >>
	|	CHAT_ATTR_DATE
	->	template(date={$CHAT_ATTR_DATE.text})
	<<
Date="<date>" >>
	|	CHAT_ATTR_CORPUS
	->	template(corpus={$CHAT_ATTR_CORPUS.text})
	<<
Corpus="<corpus>" >>
	|	CHAT_ATTR_MEDIA
	->	template(media={$CHAT_ATTR_MEDIA.text})
	<<
Media="<media>" >>
	|	CHAT_ATTR_MEDIATYPES
	->	template(types={$CHAT_ATTR_MEDIATYPES.text})
	<<
Mediatypes="<types>" >>
	|	CHAT_ATTR_LANG
	->	template(lang={$CHAT_ATTR_LANG.text})
	<<
Lang="<lang>" >>
	|	CHAT_ATTR_OPTIONS
	->	template(opts={$CHAT_ATTR_OPTIONS.text})
	<<
Options="<opts>" >>
	|	CHAT_ATTR_COLORWORDS
	->	template(wrds={$CHAT_ATTR_COLORWORDS.text})
	<<
Colorwords="<wrds>" >>
	|	CHAT_ATTR_ID
	->	template(id={$CHAT_ATTR_ID.text})
	<<
Id="<id>" >>
	|	CHAT_ATTR_PID
	->	template(pid={$CHAT_ATTR_PID.text})
	<<
PID="<pid>" >>
	|	CHAT_ATTR_FONT
	->	template(font={$CHAT_ATTR_FONT.text})
	<<
Font="<font>" >>
	;
	
]]>
	</buffer>
    
    <include>metadata.xml</include>
    <include>participants.xml</include>
    <include>comment.xml</include>
	<include>tcu.xml</include>
	<include>begin_gem.xml</include>
	<include>end_gem.xml</include>
	<include>lazy_gem.xml</include>
    <include>u.xml</include>

</chunk>
