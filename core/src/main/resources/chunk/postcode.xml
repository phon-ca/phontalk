<?xml version="1.0" encoding="UTF-8"?>

<!-- 
Postcode
XPath - /xs:schema/xs:complexType[@name="postcodeType"]
-->
<chunk xmlns="https://www.phon.ca/ns/chunk">
    
    <!-- Parser -->
    <buffer name="Chat.g">
        <![CDATA[
postcode
	:	POSTCODE_START TEXT? POSTCODE_END 
	->	^(POSTCODE_START TEXT?)
	;
]]>
    </buffer>
    
    <!-- Tree Walker -->
    <buffer name="ChatTree.g">
        <![CDATA[
postcode
	:	^(POSTCODE_START v=TEXT?)
	{
		// make a new tier in the session if necessary
		TierDescription postcodeDesc = null;
		for(TierDescription tierDesc:session.getUserTiers())
		{
			if(tierDesc.getName().equals("Postcode")) {
				postcodeDesc = tierDesc;
				break;
			}
		}
		if(postcodeDesc == null) {
			postcodeDesc = sessionFactory.createTierDescription(
				"Postcode", false, String.class);
			session.addUserTier(postcodeDesc);
			
			TierViewItem tvi = sessionFactory.createTierViewItem(
				"Postcode", true, "default");
			List<TierViewItem> tierView = session.getTierView();
			tierView.add(tvi);
			session.setTierView(tierView);
		}
		
		Tier<String> postcodeTier = $u::r.getTier("Postcode", String.class);
		if(postcodeTier == null) {
			postcodeTier = sessionFactory.createTier("Postcode", String.class, false);
			$u::r.putTier(postcodeTier);
		}
		
		postcodeTier.setGroup(0,
			(new String(postcodeTier.getGroup(0) + " " + $v.text)).trim());
	}
	;
]]>
    </buffer>
	
	<buffer name="Phon2XmlWalker.g">
		<![CDATA[
postcode
	:	^(POSTCODE_START TEXT?)
	->	template( v={$TEXT.text} )
	<<\<postcode\><v>\</postcode\> >>
	;
]]>
	</buffer>
    
</chunk>