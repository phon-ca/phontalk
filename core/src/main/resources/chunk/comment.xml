<?xml version="1.0" encoding="UTF-8"?>

<!-- 
Comment
Schema - http://www.talkbank.org/software/talkbank
XPath -	/xs:schema/xs:complexType[@name="commentType"]
		/xs:schmea/xs:element[@name="comment"]
-->
<chunk xmlns="https://www.phon.ca/ns/chunk">
    
    <!-- Parser -->
    <buffer name="Chat.g">
        <![CDATA[
comment
	:	COMMENT_START COMMENT_ATTR_TYPE? media? TEXT* COMMENT_END 
	->	^(COMMENT_START COMMENT_ATTR_TYPE? media? TEXT*)
	;
]]>
    </buffer>
    
    <!-- Tree Walker -->
    <buffer name="ChatTree.g">
        <![CDATA[
comment returns [Comment val]
scope {
	StringBuffer buffer;
}
@init {
	$comment::buffer = new StringBuffer();
}
	:	^(COMMENT_START type=COMMENT_ATTR_TYPE? media? (TEXT{$comment::buffer.append($TEXT.text);})*)
	{
		CommentEnum cType = CommentEnum.Generic;
		if($type != null)
		{
			CommentEnum t =
				CommentEnum.fromString($type.text);
			if(t != null) cType = t;
		}
		$val = sessionFactory.createComment(cType, $comment::buffer.toString());
		
		if($media != null) {
			$val.putExtension(MediaSegment.class, $media.val);
		}
	}
	;
]]>
    </buffer>
	
	<buffer name="Phon2XmlWalker.g">
		<![CDATA[
comment
	:	^(COMMENT_START ctype=COMMENT_ATTR_TYPE? m=media? vals+=TEXT*)
	->	template(
			type={$ctype.text},
			mref={$m.st},
			vals={$vals}
		)
	<<\<comment type="<type>"\><if(mref)><mref><endif><vals>\</comment\> >>
	;
]]>
	</buffer>
	
    
</chunk>
